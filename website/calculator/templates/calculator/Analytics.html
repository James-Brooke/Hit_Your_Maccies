{% extends 'calculator/base.html' %}

{% block content %}


<div class="topnav">
    <a href="home">Home</a>
    <a class = "active" href="analytics">Analytics</a>
    <a href="../about">About</a>
    <a href="contact">Contact</a>
</div>

<body>
<div class = "main">

{% csrf_token %}
{{ form }}

<script>
    // set the dimensions and margins of the graph
    var margin = {top: 20, right: 20, bottom: 400, left: 40},
        width = 960 - margin.left - margin.right,
        height = 700 - margin.top - margin.bottom;

    // append the svg object to the body of the page
    // append a 'group' element to 'svg'
    // moves the 'group' element to the top left margin
    var svg = d3.select("body").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", 
            "translate(" + margin.left + "," + margin.top + ")");

    function drawGraph(data, redraw=false) {

        if (redraw){
            var bars = svg.selectAll(".bar")
            bars.remove();
            svg.selectAll('.yaxis').remove();
            svg.selectAll('.xaxis').remove();
        };

        // define the ranges
        var x = d3.scaleBand()
            .range([0, width])
            .padding(0.1);
        var y = d3.scaleLinear()
            .range([height, 0]);

        // scale the range of the axis according to data
        x.domain(data.map(function(d) { return d.fields.name; }));
        y.domain([0, d3.max(data, function(d) { return d.fields.cal; })]);

        // define the axes
        var xAxis = d3.axisBottom(x);
        var yAxis = d3.axisLeft(y);

        // add the axes
        svg.append("g")
            .attr("class", "xaxis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis)
            .selectAll('text')
            .attr("y", -3)
            .attr("x", 9)
            .attr("transform", "rotate(90)")
            .style("text-anchor", "start");
        svg.append("g")
            .attr("class", "yaxis")
            .call(yAxis);
  

        // append the rectangles for the bar chart
        svg.selectAll(".bar")
            .data(data)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", function(d) { return x(d.fields.name); })
            .attr("width", x.bandwidth())
            .attr("y", function(d) { return y(d.fields.cal); })
            .attr("height", function(d) { return height - y(d.fields.cal); });
        };

    function drawFiltered(data, value) {
            // filter the data and remove old elements
            var filter_data = data.filter(function(d) {return d.fields.category === value;})
            drawGraph(filter_data, redraw=true);
    };

    d3.json("/data", function(error, data) {
        if (error) {
            throw error;
        };

        console.log(data[1]);

        drawGraph(data);

        // add a change event handler 
        d3.select("#id_category").on("change", function() {
            if (this.value === 'ALL'){
                drawGraph(data, redraw=true);  
            }
            else {
                drawFiltered(data, this.value);
            }
            });
    });
</script>



</div>
</body>
{% endblock %}
